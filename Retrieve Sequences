import time
import json
from Bio import Entrez
from Bio import SeqIO
from urllib.error import HTTPError

Entrez.email = "your_email@example.com"  # Replace with your email

def get_nucleotide_sequence_for_gene(gene_name, strand, start, end, max_retries=3, retry_delay=2):
    attempts = 0
    while attempts < max_retries:
        try:
            # Get accession number for the gene
            handle = Entrez.esearch(db="nucleotide", term=f"{gene_name}[Gene Name]", retmax=1)
            record = Entrez.read(handle)
            handle.close()

            if record["IdList"]:
                accession = record["IdList"][0]

                # Then fetch the sequence using the accession number
                handle = Entrez.efetch(
                    db="nucleotide", id=accession, rettype="fasta", retmode="text",
                    seq_start=start, seq_stop=end, strand=strand
                )
                sequence_data = handle.read()
                handle.close()

                # Process and return the sequence data
                return {
                    "gene": gene_name,
                    "strand": strand,
                    "sequence": sequence_data,
                    "coordinates": f"{start}-{end}"
                }
        except HTTPError as e:
            if e.code == 400:
                print(f"HTTP Error 400 occurred for gene {gene_name}. Retrying... (Attempt {attempts + 1})")
                attempts += 1
                time.sleep(retry_delay)
            else:
                print(f"Error occurred for gene {gene_name}: {e}")
                break
        except Exception as e:
            print(f"Error occurred for gene {gene_name}: {e}")
            attempts += 1
            time.sleep(retry_delay)
    
    return {
        "gene": gene_name,
        "strand": strand,
        "sequence": "Information not available or max retries reached",
        "coordinates": f"{start}-{end}"
    }
